<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile â€” Sunforce</title>
    <meta
      name="description"
      content="Manage your Sunforce Green Energy client profile."
    />
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%2322C55E'/%3E%3Cstop offset='100%25' stop-color='%2316A34A'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='30' fill='url(%23g)'/%3E%3Ctext x='32' y='42' font-size='32' text-anchor='middle' fill='white' font-family='Arial Black'%3ES%3C/text%3E%3C/svg%3E"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              background: "#f8f5f2", foreground: "#1f1c18", card: "#ffffff",
              "card-foreground": "#1f1c18", primary: "#16a34a", "primary-foreground": "#ffffff",
              secondary: "#22c55e", border: "rgba(0, 0, 0, 0.08)",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"], serif: ["Playfair Display", "serif"],
            },
            boxShadow: {
              soft: "0 4px 12px rgba(0, 0, 0, 0.05)",
              lift: "0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1)",
              glow: "0 0 20px rgba(22, 163, 74, 0.15)",
            },
            animation: { backgroundShift: "backgroundShift 25s ease infinite" },
            keyframes: {
              backgroundShift: { "0%, 100%": { backgroundPosition: "0% 50%" }, "50%": { backgroundPosition: "100% 50%" } },
            },
          },
        },
      };
    </script>
    <style>
      body {
        background: linear-gradient(-45deg, #f0fdf4, #f9fafb, #eefbf3, #f9fafb);
        background-size: 400% 400%; animation: backgroundShift 25s ease infinite;
      }
      .glass-header {
        background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--tw-color-border);
      }
      .nav-link {
        transition: all 0.2s ease-in-out; border-bottom: 2px solid transparent;
      }
      .nav-link.active, .nav-link:hover {
        color: var(--tw-color-primary); border-bottom-color: var(--tw-color-primary);
      }
    </style>
  </head>
  <body class="bg-background font-sans antialiased text-foreground">
    <header class="fixed top-0 inset-x-0 z-40 glass-header">
      <div class="mx-auto max-w-screen-xl px-4 sm:px-6 lg:px-8">
        <div class="relative flex h-16 items-center justify-between">
          <a href="/" class="text-3xl font-serif font-bold text-primary">Sunforce</a>
          <a href="/logout" class="px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-green-700 transition-colors font-semibold shadow-soft flex items-center gap-2">
            <i data-lucide="log-out" class="w-4 h-4"></i> Logout
          </a>
        </div>
      </div>
    </header>

    <main class="pt-16">
      <nav class="bg-card border-b border-border px-4 py-2 sticky top-16 z-30">
        <div class="max-w-screen-xl mx-auto flex justify-center items-center">
          <div class="flex gap-4 overflow-x-auto">
            <a href="/student/dashboard" class="nav-link flex-shrink-0 flex items-center gap-2 px-3 py-2 text-sm font-semibold"><i data-lucide="layout-dashboard"></i>Dashboard</a>
            <a href="/student/connections" class="nav-link flex-shrink-0 flex items-center gap-2 px-3 py-2 text-sm font-semibold"><i data-lucide="users"></i>Our Team</a>
            <a href="/student/posts" class="nav-link flex-shrink-0 flex items-center gap-2 px-3 py-2 text-sm font-semibold"><i data-lucide="newspaper"></i>Announcements</a>
            <a href="/student/map" class="nav-link flex-shrink-0 flex items-center gap-2 px-3 py-2 text-sm font-semibold"><i data-lucide="map"></i>Global Reach</a>
            <a href="/student/events" class="nav-link flex-shrink-0 flex items-center gap-2 px-3 py-2 text-sm font-semibold"><i data-lucide="calendar"></i>Site Visit Requests</a>
            <a href="/student/profile" class="nav-link active flex-shrink-0 flex items-center gap-2 px-3 py-2 text-sm font-semibold"><i data-lucide="user-circle"></i>My Profile</a>
          </div>
        </div>
      </nav>

      <div class="max-w-screen-xl mx-auto p-6 md:p-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-1">
             <form action="/student/profile" method="POST" enctype="multipart/form-data" class="bg-card rounded-xl shadow-soft p-6 space-y-6 sticky top-36">
                <div class="text-center">
                    <label for="image-upload" class="cursor-pointer group relative inline-block">
                         <% if (user.image) { %>
                            <img src="data:image/jpeg;base64,<%= user.image.toString('base64') %>" alt="Profile Photo" id="profile-image-preview" class="h-28 w-28 rounded-full object-cover ring-4 ring-primary/20 shadow-soft mx-auto"/>
                        <% } else { %>
                             <div id="profile-initials-preview" class="h-28 w-28 rounded-full flex items-center justify-center bg-secondary text-primary-foreground text-5xl font-bold ring-4 ring-primary/20 shadow-soft mx-auto">
                                <%= user.fullname ? user.fullname.charAt(0).toUpperCase() : "C" %>
                            </div>
                        <% } %>
                        <div class="absolute inset-0 rounded-full bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                             <i data-lucide="camera" class="w-8 h-8 text-white"></i>
                        </div>
                    </label>
                    <input type="file" name="image" id="image-upload" class="hidden" accept="image/*">
                </div>

                <div>
                    <label for="fullname" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" name="fullname" id="fullname" value="<%= user.fullname %>" class="w-full border border-border rounded-md bg-background px-4 py-2.5 focus:ring-2 focus:ring-primary focus:outline-none">
                </div>
                 <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" name="email" id="email" value="<%= user.email %>" class="w-full border border-border rounded-md bg-gray-100 px-4 py-2.5" readonly>
                </div>
                  <div>
                    <label for="contact" class="block text-sm font-medium text-gray-700 mb-1">Contact Number</label>
                    <input type="tel" name="contact" id="contact" value="<%= user.contact || '' %>" class="w-full border border-border rounded-md bg-background px-4 py-2.5 focus:ring-2 focus:ring-primary focus:outline-none">
                </div>
                <div>
                    <label for="branch" class="block text-sm font-medium text-gray-700 mb-1">Property Type</label>
                    <input type="text" name="branch" id="branch" value="<%= user.branch || '' %>" placeholder="e.g., Residential, Commercial" class="w-full border border-border rounded-md bg-background px-4 py-2.5 focus:ring-2 focus:ring-primary focus:outline-none">
                </div>
                
                <div>
                     <label for="interest-input" class="block text-sm font-medium text-gray-700 mb-1">Services of Interest</label>
                    <div class="flex items-center gap-2">
                         <input type="text" id="interest-input" placeholder="e.g., Solar Panels" class="w-full border border-border rounded-md bg-background px-4 py-2.5 focus:ring-2 focus:ring-primary focus:outline-none">
                         <button type="button" id="add-interest-btn" class="px-4 py-2.5 bg-primary/10 text-primary hover:bg-primary hover:text-primary-foreground rounded-lg font-bold text-sm transition-colors">Add</button>
                    </div>
                    <div id="interests-container" class="mt-3 flex flex-wrap gap-2">
                        </div>
                    <input type="hidden" name="interests" id="interests-hidden-input">
                </div>

                 <button type="submit" class="w-full px-6 py-3 rounded-lg bg-primary text-primary-foreground font-semibold hover:bg-green-700 transition-colors shadow-soft">
                    Save Changes
                 </button>
             </form>
          </div>

          <div class="lg:col-span-2 space-y-8">
            <div>
               <div class="flex justify-between items-center mb-4">
                 <h3 class="text-2xl font-serif font-bold text-foreground">Our Team (<%= connections.length %>)</h3>
                 <a href="/student/connections" class="px-4 py-2 bg-primary/10 text-primary hover:bg-primary hover:text-white rounded-lg font-bold text-sm transition-colors">View All</a>
              </div>
              <div class="bg-card rounded-xl shadow-soft p-6">
                 <% if (connections && connections.length > 0) { %>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <% connections.slice(0, 4).forEach(alumnus => { %>
                           <div class="flex items-center gap-3">
                               <div class="h-12 w-12 rounded-full flex-shrink-0 flex items-center justify-center bg-secondary text-primary-foreground font-bold">
                                   <%= alumnus.name ? alumnus.name.charAt(0).toUpperCase() : 'A' %>
                               </div>
                               <div>
                                   <p class="font-semibold text-card-foreground"><%= alumnus.name %></p>
                                   <p class="text-xs text-gray-500"><%= alumnus.designation %></p>
                               </div>
                          </div>
                        <% }); %>
                    </div>
                <% } else { %>
                    <p class="text-center text-gray-500 py-4">You haven't connected with any team members yet.</p>
                <% } %>
              </div>
            </div>

            <div>
              <h3 class="text-2xl font-serif font-bold text-foreground mb-4">My Site Visit Requests</h3>
              <div class="bg-card rounded-xl shadow-soft">
                <div class="space-y-2">
                    <% if (eventRequests && eventRequests.length > 0) { %>
                        <% eventRequests.forEach(request => { %>
                            <div class="p-5 flex justify-between items-center border-b border-border last:border-b-0">
                                 <div>
                                    <p class="font-semibold text-card-foreground"><%= request.title %></p>
                                    <p class="text-sm text-gray-500">Submitted on <%= new Date(request.createdAt).toLocaleDateString() %></p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold capitalize text-sm <%= request.status === 'pending' ? 'text-yellow-500' : 'text-primary' %>"><%= request.status %></p>
                                </div>
                            </div>
                        <% }); %>
                   <% } else { %>
                        <p class="text-center text-gray-500 p-10">You haven't made any site visit requests.</p>
                   <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        lucide.createIcons();
        
        // --- Image Preview Logic ---
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('profile-image-preview');
        const initialsPreview = document.getElementById('profile-initials-preview');
        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if(imagePreview) {
                       imagePreview.src = e.target.result;
                    } else {
                        const newImg = document.createElement('img');
                        newImg.src = e.target.result;
                        newImg.alt = "Profile Photo";
                        newImg.className = "h-28 w-28 rounded-full object-cover ring-4 ring-primary/20 shadow-soft mx-auto";
                        initialsPreview.replaceWith(newImg);
                    }
                }
                reader.readAsDataURL(file);
            }
        });

        // --- Interactive Interests Logic ---
        const interestInput = document.getElementById('interest-input');
        const addInterestBtn = document.getElementById('add-interest-btn');
        const interestsContainer = document.getElementById('interests-container');
        const hiddenInterestsInput = document.getElementById('interests-hidden-input');
        
        const updateHiddenInput = () => {
            const tags = interestsContainer.querySelectorAll('.interest-tag-text');
            const interests = Array.from(tags).map(tag => tag.textContent);
            hiddenInterestsInput.value = interests.join(',');
        };
        
        const createTag = (interest) => {
            const tag = document.createElement('div');
            tag.className = 'flex items-center bg-secondary text-primary-foreground text-sm font-semibold px-3 py-1 rounded-full';
            const tagText = document.createElement('span');
            tagText.className = 'interest-tag-text';
            tagText.textContent = interest;
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'ml-2 text-primary-foreground/70 hover:text-primary-foreground';
            removeBtn.innerHTML = '<i data-lucide="x" class="w-4 h-4"></i>';
            removeBtn.onclick = () => {
                tag.remove();
                updateHiddenInput();
            };
            tag.appendChild(tagText);
            tag.appendChild(removeBtn);
            interestsContainer.appendChild(tag);
            lucide.createIcons();
        };
        
        const addInterest = () => {
            const interest = interestInput.value.trim();
            if (interest) {
                createTag(interest);
                updateHiddenInput();
                interestInput.value = '';
            }
        };

        addInterestBtn.addEventListener('click', addInterest);
        interestInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addInterest();
            }
        });
        
        const existingInterests = "<%= user.interests ? user.interests.join(',') : '' %>";
        if (existingInterests) {
            existingInterests.split(',').forEach(interest => {
                if(interest) createTag(interest);
            });
            updateHiddenInput();
        }
      });
    </script>
  </body>
</html>